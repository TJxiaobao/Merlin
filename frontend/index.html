<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧙 Merlin - AI Excel 助手</title>
    <!-- Handsontable -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
</head>

<body>
    <!-- 顶部栏 -->
    <div class="topbar">
        <div class="topbar-content">
            <div class="topbar-logo">
                <span class="logo-icon">🧙</span>
                <span class="logo-text">Merlin</span>
            </div>
            <div class="topbar-subtitle">AI Excel 助手 - 用自然语言操作表格</div>
        </div>
    </div>

    <!-- 主容器 -->
    <div class="main-container">
        <!-- 左侧栏：上下文面板 -->
        <div class="sidebar">
            <!-- 区域 1: 文件操作 -->
            <div class="sidebar-section file-section">
                <div class="section-title">📁 文件</div>

                <!-- 未上传状态 -->
                <div class="file-upload-area" id="dropZone">
                    <div class="upload-icon">📁</div>
                    <div class="upload-text">点击或拖拽上传</div>
                    <div class="upload-hint">支持 .xlsx 格式</div>
                    <input type="file" id="fileInput" accept=".xlsx">
                </div>

                <!-- 已上传状态 -->
                <div class="file-info-card" id="fileInfoCard" style="display: none;">
                    <div class="file-name" id="fileName"></div>
                    <div class="file-stats">
                        <span id="totalRows">0</span> 行 × <span id="totalColumns">0</span> 列
                    </div>
                    <div class="file-actions">
                        <button class="file-action-btn" id="downloadOriginalBtn" title="下载原始文件">
                            📥 下载原始
                        </button>
                        <button class="file-action-btn" id="editFileBtn" title="实时编辑">
                            ✏️ 实时编辑
                        </button>
                        <button class="file-action-btn" id="uploadNewBtn" title="上传新文件">
                            🔄 上传新文件
                        </button>
                    </div>
                </div>
            </div>

            <!-- 区域 2: 列名列表 (可复制) -->
            <div class="sidebar-section columns-section" id="columnsSection" style="display: none;">
                <div class="section-title">
                    📝 列名 (<span id="columnCount">0</span>)
                </div>
                <div class="columns-list-scrollable" id="columnsList">
                    <!-- 动态生成列名列表 -->
                </div>
            </div>

            <!-- 区域 3: 操作历史 (未来功能) -->
            <div class="sidebar-section history-section" style="display: none;">
                <div class="section-title">📜 操作历史</div>
                <div class="history-placeholder">
                    即将推出
                </div>
            </div>
        </div>

        <!-- 主聊天区：交互面板 -->
        <div class="chat-panel">
            <!-- 聊天消息容器 -->
            <div class="messages-container" id="messagesContainer">
                <!-- 空状态提示 -->
                <div class="empty-state" id="emptyState">
                    <div class="empty-state-icon">🧙</div>
                    <h2 class="empty-state-title">你好，我是 Merlin</h2>
                    <p class="empty-state-text" id="emptyStateText">
                        请先上传一个 Excel 文件，然后用自然语言告诉我你想做什么
                    </p>
                    <div class="empty-state-suggestions" id="emptyStateSuggestions" style="display: none;">
                        <p class="suggestions-intro">我已读完你的文件。你可以试试这样说：</p>
                        <button class="suggestion-btn" onclick="fillExample('把所有税率设为 0.13')">
                            "把所有税率设为 0.13"
                        </button>
                        <button class="suggestion-btn" onclick="fillExample('统计设备类型的分布')">
                            "统计设备类型的分布"
                        </button>
                        <button class="suggestion-btn" onclick="fillExample('计算总价等于数量乘以单价')">
                            "计算总价等于数量乘以单价"
                        </button>
                        <p class="suggestions-footer">
                            或者，点击 <strong>✨</strong> 按钮查看所有功能
                        </p>
                    </div>
                </div>
            </div>

            <!-- 输入栏（固定在底部） -->
            <div class="chat-input-bar">
                <div class="input-wrapper">
                    <button class="magic-wand-btn" id="magicWandBtn" disabled title="查看所有功能">
                        ✨
                    </button>
                    <textarea id="commandInput" placeholder="请先上传Excel文件..." rows="1" disabled></textarea>
                    <button class="send-btn" id="sendBtn" disabled>
                        <span id="sendBtnText">发送</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 功能示例模态框 -->
    <div class="modal-overlay" id="featureModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">✨ Merlin 魔法指令</h2>
                <button class="modal-close" id="modalClose">×</button>
            </div>

            <div class="feature-category">
                <h3 class="category-title">📝 数据填充与修改</h3>
                <div class="feature-example" data-command="把所有税率设为0.13">
                    <span class="feature-example-text">把所有税率设为0.13</span>
                    <span class="feature-example-hint">点击填充</span>
                </div>
                <div class="feature-example" data-command="把设备类型是Gateway的未税单价设为100">
                    <span class="feature-example-text">把设备类型是Gateway的未税单价设为100</span>
                    <span class="feature-example-hint">点击填充</span>
                </div>
                <div class="feature-example" data-command="把设备编码为196001的价格设为100，196002的设为200">
                    <span class="feature-example-text">把设备编码为196001的价格设为100，196002的设为200</span>
                    <span class="feature-example-hint">点击填充</span>
                </div>
            </div>

            <div class="feature-category">
                <h3 class="category-title">🧮 数学计算</h3>
                <div class="feature-example" data-command="让总价等于数量乘以单价">
                    <span class="feature-example-text">让总价等于数量乘以单价</span>
                    <span class="feature-example-hint">点击填充</span>
                </div>
                <div class="feature-example" data-command="计算利润等于售价减去成本价">
                    <span class="feature-example-text">计算利润等于售价减去成本价</span>
                    <span class="feature-example-hint">点击填充</span>
                </div>
                <div class="feature-example" data-command="把未税单价乘以1.13存入含税单价，保留2位小数">
                    <span class="feature-example-text">把未税单价乘以1.13存入含税单价，保留2位小数</span>
                    <span class="feature-example-hint">点击填充</span>
                </div>
            </div>

            <div class="feature-category">
                <h3 class="category-title">🧹 数据清洗</h3>
                <div class="feature-example" data-command="清理设备名称列的空格">
                    <span class="feature-example-text">清理设备名称列的空格</span>
                    <span class="feature-example-hint">点击填充</span>
                </div>
                <div class="feature-example" data-command="把备注列的空白单元格填充为N/A">
                    <span class="feature-example-text">把备注列的空白单元格填充为N/A</span>
                    <span class="feature-example-hint">点击填充</span>
                </div>
                <div class="feature-example" data-command="把客户区域列里的北京都替换成华北区">
                    <span class="feature-example-text">把客户区域列里的北京都替换成华北区</span>
                    <span class="feature-example-hint">点击填充</span>
                </div>
            </div>

            <div class="feature-category">
                <h3 class="category-title">📊 统计分析</h3>
                <div class="feature-example" data-command="统计设备类型的分布">
                    <span class="feature-example-text">统计设备类型的分布</span>
                    <span class="feature-example-hint">点击填充</span>
                </div>
                <div class="feature-example" data-command="帮我看看设备编码有哪些">
                    <span class="feature-example-text">帮我看看设备编码有哪些</span>
                    <span class="feature-example-hint">点击填充</span>
                </div>
                <div class="feature-example" data-command="按设备类型分组，计算未税单价的平均值">
                    <span class="feature-example-text">按设备类型分组，计算未税单价的平均值</span>
                    <span class="feature-example-hint">点击填充</span>
                </div>
            </div>

            <div class="feature-category">
                <h3 class="category-title">✏️ 文本处理</h3>
                <div class="feature-example" data-command="把姓和名合并为全名，用空格连接">
                    <span class="feature-example-text">把姓和名合并为全名，用空格连接</span>
                    <span class="feature-example-hint">点击填充</span>
                </div>
                <div class="feature-example" data-command="把产品编码列全部转为大写">
                    <span class="feature-example-text">把产品编码列全部转为大写</span>
                    <span class="feature-example-hint">点击填充</span>
                </div>
            </div>

            <div class="feature-category">
                <h3 class="category-title">🏗️ 表格结构</h3>
                <div class="feature-example" data-command="删除重复行">
                    <span class="feature-example-text">删除重复行</span>
                    <span class="feature-example-hint">点击填充</span>
                </div>
                <div class="feature-example" data-command="按销售额列降序排序">
                    <span class="feature-example-text">按销售额列降序排序</span>
                    <span class="feature-example-hint">点击填充</span>
                </div>
            </div>

            <div class="modal-footer">
                💡 提示：点击任一示例自动填入聊天框，记得把列名替换成你表格里的实际列名哦！
            </div>
        </div>
    </div>

    <!-- 编辑器模态框 -->
    <div class="modal-overlay" id="editorModal" style="display: none;">
        <div class="modal-content editor-modal-content">
            <div class="modal-header">
                <h2 class="modal-title">📝 实时编辑</h2>
                <div class="modal-actions">
                    <button class="modal-btn secondary" id="editorCancelBtn">取消</button>
                    <button class="modal-btn primary" id="editorSaveBtn">保存修改</button>
                </div>
            </div>
            <div class="editor-container" id="spreadsheetEditor"></div>
        </div>
    </div>

    <script type="module" src="/main.js"></script>
</body>

</html>